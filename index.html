<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>GeoFlyer</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #0a0e3a;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  overflow: hidden;
  font-family: 'Arial', sans-serif;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

canvas#bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

.menu {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

h1 {
  color: #fff;
  font-size: 52px;
  text-shadow: 0 0 30px #0af, 0 0 60px #07f, 0 0 90px #05a;
  margin-bottom: 4px;
  text-align: center;
}

h2 {
  color: #8af;
  font-size: 20px;
  font-weight: 400;
  margin-bottom: 24px;
  text-shadow: 0 0 10px #0af;
}

.mode-cards {
  display: flex;
  gap: 24px;
}

.mode-card {
  width: 280px;
  background: rgba(10, 10, 40, 0.85);
  border: 2px solid #2a2a60;
  border-radius: 16px;
  padding: 28px 24px;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.mode-card:hover {
  border-color: #0af;
  transform: translateY(-4px);
  box-shadow: 0 8px 30px rgba(0, 170, 255, 0.25);
  background: rgba(15, 15, 60, 0.9);
}

.mode-icon {
  font-size: 48px;
  line-height: 1;
}

.mode-card h3 {
  color: #fff;
  font-size: 22px;
  text-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
}

.mode-card p {
  color: #8899bb;
  font-size: 13px;
  text-align: center;
  line-height: 1.5;
}

.mode-card .tag {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}

.tag-level {
  background: rgba(0, 255, 100, 0.15);
  color: #0f0;
  border: 1px solid rgba(0, 255, 100, 0.3);
}

.tag-endless {
  background: rgba(255, 100, 0, 0.15);
  color: #f80;
  border: 1px solid rgba(255, 100, 0, 0.3);
}

#skinOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 100;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  transition: background 0.4s;
}
#skinOverlay.open { display: flex; }
#achOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 100;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: rgba(10, 10, 30, 0.95);
}
#achOverlay.open { display: flex; }
#trailOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 100;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: rgba(10, 10, 30, 0.95);
}
#trailOverlay.open { display: flex; }
#lbOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 100;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: rgba(10, 10, 30, 0.95);
}
#lbOverlay.open { display: flex; }

.skin-picker {
  display: flex;
  align-items: center;
  gap: 28px;
}
.skin-arrow {
  background: none;
  border: none;
  color: rgba(255,255,255,0.8);
  font-size: 48px;
  cursor: pointer;
  user-select: none;
  padding: 10px;
  transition: all 0.12s;
  text-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.skin-arrow:hover {
  color: #fff;
  transform: scale(1.2);
}
#skinPreviewBox {
  width: 260px;
  height: 220px;
  background: rgba(0,0,0,0.55);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: inset 0 2px 12px rgba(0,0,0,0.4);
}
#skinPreviewBox canvas {
  display: block;
}
#skinTitle {
  color: #fff;
  font-size: 28px;
  font-weight: bold;
  text-shadow: 0 0 20px rgba(0,0,0,0.5);
}
#skinName {
  color: rgba(255,255,255,0.6);
  font-size: 18px;
  margin-top: 4px;
  margin-bottom: 20px;
  text-shadow: 0 0 10px rgba(0,0,0,0.4);
}
.skin-close-x {
  position: absolute;
  top: 20px;
  right: 28px;
  background: none;
  border: none;
  color: rgba(255,255,255,0.5);
  font-size: 32px;
  cursor: pointer;
  transition: all 0.12s;
}
.skin-close-x:hover {
  color: #fff;
}
.skin-back {
  margin-top: 24px;
  padding: 10px 36px;
  background: rgba(255,255,255,0.1);
  border: 2px solid rgba(255,255,255,0.25);
  border-radius: 10px;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: 'Arial', sans-serif;
}
.skin-back:hover, .skin-back:active {
  background: rgba(255,255,255,0.2);
  border-color: rgba(255,255,255,0.5);
}

.mode-card:active {
  border-color: #0af;
  transform: translateY(-4px);
  box-shadow: 0 8px 30px rgba(0, 170, 255, 0.25);
  background: rgba(15, 15, 60, 0.9);
}

.skin-arrow:active {
  color: #fff;
  transform: scale(1.2);
}

.skin-close-x:active {
  color: #fff;
}

@media (max-width: 700px) {
  body { overflow-y: auto; align-items: flex-start; padding: 24px 0; }
  .menu { gap: 12px; padding: 0 12px; }
  h1 { font-size: 32px; }
  h2 { font-size: 16px; margin-bottom: 16px; }
  .mode-cards { flex-wrap: wrap; justify-content: center; gap: 12px; }
  .mode-card { width: 85vw !important; max-width: 320px; padding: 18px 16px !important; }
  .mode-card h3 { font-size: 18px; }
  .mode-card p { font-size: 12px; }
  .mode-icon { font-size: 36px; }
  .skin-picker { gap: 12px; }
  #skinPreviewBox { width: 180px; height: 160px; }
  #skinPreviewBox canvas { width: 160px; height: 140px; }
  #skinTitle { font-size: 22px; }
  #skinName { font-size: 15px; margin-bottom: 12px; }
  .skin-arrow { font-size: 36px; padding: 8px; }
  .skin-close-x { font-size: 36px; padding: 10px; top: 12px; right: 16px; }
  .skin-back { padding: 12px 36px; min-height: 44px; }
  #achList { max-width: 90vw !important; }
  #usernameInput { width: 140px !important; font-size: 13px !important; }
  #lbList { max-width: 90vw !important; }
  .lb-row { font-size: 13px !important; padding: 6px 10px !important; }
}

</style>
</head>
<body>

<canvas id="bg"></canvas>

<div class="menu">
  <h1>GEOFLYER</h1>
  <h2>How far can you fly?</h2>

  <div class="mode-cards">
    <div class="mode-card" style="width:180px;padding:20px 16px;" onclick="document.getElementById('skinOverlay').classList.add('open')">
      <canvas id="skinBtnCanvas" width="60" height="48" style="border-radius:6px;"></canvas>
      <h3>Skins</h3>
    </div>
    <a class="mode-card" href="endless.html">
      <span class="mode-icon">&#9654;</span>
      <h3>Play</h3>
      <span class="tag tag-endless">ENDLESS</span>
      <p>Randomly generated obstacles that go on forever. How far can you fly? Difficulty increases over time.</p>
    </a>
    <div class="mode-card" style="width:180px;padding:20px 16px;" onclick="document.getElementById('trailOverlay').classList.add('open')">
      <canvas id="trailBtnCanvas" width="60" height="48" style="border-radius:6px;"></canvas>
      <h3>Trails</h3>
    </div>
  </div>

  <div class="mode-card" style="width:200px;padding:12px 20px;flex-direction:row;gap:10px;" onclick="document.getElementById('achOverlay').classList.add('open')">
    <span style="font-size:24px;">&#127942;</span>
    <h3 style="font-size:18px;">Achievements</h3>
  </div>

  <div id="menuCoins" style="margin-top:6px;color:#ffd600;font-size:14px;text-shadow:0 0 8px #ffd600;">&#9733; 0 coins</div>

  <div id="usernameRow" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
    <input id="usernameInput" type="text" maxlength="20" placeholder="Enter username..." value=""
      style="background:rgba(10,10,40,0.85);border:2px solid #2a2a60;border-radius:8px;color:#fff;font-size:14px;padding:6px 12px;width:180px;font-family:'Arial',sans-serif;outline:none;transition:border-color 0.2s;"
      onfocus="this.style.borderColor='#0af'" onblur="this.style.borderColor='#2a2a60'">
    <button id="usernameSave" style="background:rgba(0,170,255,0.12);border:2px solid #0af;border-radius:8px;color:#0af;font-size:13px;padding:6px 14px;cursor:pointer;font-family:'Arial',sans-serif;transition:all 0.15s;"
      onmouseover="this.style.background='rgba(0,170,255,0.25)'" onmouseout="this.style.background='rgba(0,170,255,0.12)'">Save</button>
  </div>

  <div class="mode-card" style="width:200px;padding:12px 20px;flex-direction:row;gap:10px;margin-top:4px;" onclick="openLeaderboard()">
    <span style="font-size:24px;">&#127941;</span>
    <h3 style="font-size:18px;">Leaderboard</h3>
  </div>

  <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
    <button style="background:rgba(255,50,50,0.12);border:1px solid #c33;border-radius:6px;color:#f66;font-size:12px;padding:8px 16px;cursor:pointer;font-family:'Arial',sans-serif;" onclick="if(confirm('Reset ALL progress? Coins, skins, achievements, trails, and high score will be lost.')){localStorage.removeItem('geoflyer-coins');localStorage.removeItem('geoflyer-unlocked');localStorage.removeItem('geoflyer-achievements');localStorage.removeItem('geoflyer-unlocked-trails');localStorage.removeItem('geoflyer-skin');localStorage.removeItem('geoflyer-trail');localStorage.removeItem('geoflyer-streak-skin');localStorage.removeItem('geoflyer-streak-count');localStorage.removeItem('endless-high');location.reload();}">Reset Progress</button>
  </div>
</div>

<script>
// Animated background
const C = document.getElementById('bg');
const X = C.getContext('2d');

function resize() {
  C.width = innerWidth;
  C.height = innerHeight;
}
resize();
addEventListener('resize', resize);

const stars = [];
for (let i = 0; i < 80; i++) stars.push({
  x: Math.random() * 2000,
  y: Math.random() * 1200,
  sz: Math.random() * 2.5 + 0.5,
  br: Math.random() * 0.5 + 0.3,
  sp: Math.random() * 0.3 + 0.1
});

const rects = [];
for (let i = 0; i < 12; i++) rects.push({
  x: Math.random() * 2000 - 200,
  y: Math.random() * 1200,
  w: 80 + Math.random() * 200,
  h: 40 + Math.random() * 120,
  sp: Math.random() * 0.2 + 0.05
});

let t = 0;
function draw() {
  t++;
  X.fillStyle = '#0a0e3a';
  X.fillRect(0, 0, C.width, C.height);

  X.fillStyle = '#101878';
  X.strokeStyle = '#1a2494';
  X.lineWidth = 2;
  for (const r of rects) {
    const rx = ((r.x - t * r.sp) % (C.width + 400));
    const ax = rx < -300 ? rx + C.width + 400 : rx;
    X.fillRect(ax, r.y, r.w, r.h);
    X.strokeRect(ax, r.y, r.w, r.h);
  }

  for (const s of stars) {
    let sx = ((s.x - t * s.sp) % (C.width + 40));
    if (sx < -20) sx += C.width + 40;
    const a = s.br + Math.sin(t * 0.03 + s.x) * 0.15;
    X.fillStyle = `rgba(255,255,200,${Math.max(0, a)})`;
    X.fillRect(sx, s.y % C.height, s.sz, s.sz);
  }

  const gndY = C.height * 0.82;
  X.fillStyle = '#04061a';
  X.fillRect(0, gndY, C.width, C.height - gndY);
  X.strokeStyle = '#4488ff';
  X.lineWidth = 2;
  X.beginPath();
  X.moveTo(0, gndY);
  X.lineTo(C.width, gndY);
  X.stroke();

  X.strokeStyle = 'rgba(68,136,255,0.08)';
  X.lineWidth = 1;
  const gSize = 40;
  const gOff = (t * 0.5) % gSize;
  for (let x = -gOff; x < C.width + gSize; x += gSize) {
    X.beginPath(); X.moveTo(x, gndY); X.lineTo(x, C.height); X.stroke();
  }
  for (let y = gndY + gSize; y < C.height; y += gSize) {
    X.beginPath(); X.moveTo(0, y); X.lineTo(C.width, y); X.stroke();
  }

  requestAnimationFrame(draw);
}
draw();
</script>

<div id="skinOverlay">
  <button class="skin-close-x" onclick="document.getElementById('skinOverlay').classList.remove('open')">&times;</button>
  <div id="skinTitle">Skin Select</div>
  <div id="skinName"></div>
  <div class="skin-picker">
    <button class="skin-arrow" id="skinPrev">&#9664;</button>
    <div id="skinPreviewBox">
      <canvas id="skinCanvas" width="240" height="190"></canvas>
    </div>
    <button class="skin-arrow" id="skinNext">&#9654;</button>
  </div>
  <div id="skinDots" style="display:flex;gap:6px;margin-top:10px;justify-content:center;align-items:center;"></div>
  <div id="coinDisplay" style="color:#ffd600;font-size:16px;margin-top:8px;text-shadow:0 0 8px #ffd600;">&#9733; 0 coins</div>
  <div id="skinStatus" style="color:#ff6666;font-size:15px;margin-top:4px;min-height:20px;"></div>
  <button id="unlockBtn" style="display:none;margin-top:6px;padding:8px 28px;background:rgba(255,214,0,0.15);border:2px solid #ffd600;border-radius:10px;color:#ffd600;font-size:15px;cursor:pointer;font-family:'Arial',sans-serif;transition:all 0.15s;" onmouseover="this.style.background='rgba(255,214,0,0.3)'" onmouseout="this.style.background='rgba(255,214,0,0.15)'">Unlock</button>
  <button class="skin-back" onclick="document.getElementById('skinOverlay').classList.remove('open')">Back</button>
</div>

<div id="achOverlay">
  <button class="skin-close-x" onclick="document.getElementById('achOverlay').classList.remove('open')">&times;</button>
  <div style="color:#fff;font-size:28px;font-weight:bold;text-shadow:0 0 20px rgba(0,0,0,0.5);margin-bottom:20px;">Achievements</div>
  <div id="achList" style="display:flex;flex-direction:column;gap:12px;max-width:400px;width:90%;"></div>
  <button class="skin-back" onclick="document.getElementById('achOverlay').classList.remove('open')" style="margin-top:24px;">Back</button>
</div>

<div id="trailOverlay">
  <button class="skin-close-x" onclick="document.getElementById('trailOverlay').classList.remove('open')">&times;</button>
  <div style="color:#fff;font-size:28px;font-weight:bold;text-shadow:0 0 20px rgba(0,0,0,0.5);margin-bottom:6px;">Trail Select</div>
  <div id="trailName" style="color:rgba(255,255,255,0.6);font-size:18px;margin-bottom:16px;"></div>
  <div style="display:flex;align-items:center;gap:20px;">
    <button class="skin-arrow" id="trailPrev">&#9664;</button>
    <canvas id="trailCanvas" width="200" height="80" style="background:rgba(0,0,0,0.4);border-radius:10px;"></canvas>
    <button class="skin-arrow" id="trailNext">&#9654;</button>
  </div>
  <div id="trailDots" style="display:flex;gap:6px;margin-top:10px;justify-content:center;align-items:center;"></div>
  <button class="skin-back" onclick="document.getElementById('trailOverlay').classList.remove('open')" style="margin-top:20px;">Back</button>
</div>

<div id="lbOverlay">
  <button class="skin-close-x" onclick="closeLB()">&times;</button>
  <div style="color:#fff;font-size:28px;font-weight:bold;text-shadow:0 0 20px rgba(0,0,0,0.5);margin-bottom:20px;">Leaderboard</div>
  <div id="lbList" style="display:flex;flex-direction:column;gap:4px;max-width:420px;width:90%;max-height:60vh;overflow-y:auto;"></div>
  <button class="skin-back" onclick="closeLB()" style="margin-top:24px;">Back</button>
</div>

<script>
// Leaderboard + Username logic (global scope)
function openLeaderboard() {
  document.getElementById('lbOverlay').classList.add('open');
  const list = document.getElementById('lbList');
  list.innerHTML = '<div style="color:#8899bb;font-size:14px;text-align:center;padding:20px;">Loading...</div>';
  fetch('/api/leaderboard')
    .then(r => r.json())
    .then(data => {
      const scores = data.scores || [];
      if (scores.length === 0) {
        list.innerHTML = '<div style="color:#8899bb;font-size:14px;text-align:center;padding:20px;">No scores yet. Be the first!</div>';
        return;
      }
      const username = (localStorage.getItem('geoflyer-username') || '').toLowerCase();
      list.innerHTML = scores.map((s, i) => {
        const isMe = username && s.name.toLowerCase() === username;
        const bg = isMe ? 'rgba(0,170,255,0.15)' : (i % 2 === 0 ? 'rgba(255,255,255,0.03)' : 'transparent');
        const border = isMe ? 'border:1px solid rgba(0,170,255,0.3);' : '';
        const medal = i === 0 ? '\u{1F947}' : i === 1 ? '\u{1F948}' : i === 2 ? '\u{1F949}' : '';
        return '<div class="lb-row" style="display:flex;justify-content:space-between;align-items:center;padding:8px 14px;border-radius:8px;background:'+bg+';'+border+'">' +
          '<span style="color:#8899bb;font-size:14px;min-width:36px;">' + (medal || '#'+(i+1)) + '</span>' +
          '<span style="color:'+(isMe?'#0af':'#fff')+';font-size:15px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escHtml(s.name) + '</span>' +
          '<span style="color:#0f0;font-size:15px;font-weight:bold;text-shadow:0 0 6px #0f0;">' + s.score + 'm</span>' +
        '</div>';
      }).join('');
    })
    .catch(() => {
      list.innerHTML = '<div style="color:#f66;font-size:14px;text-align:center;padding:20px;">Could not load leaderboard</div>';
    });
}
function closeLB() { document.getElementById('lbOverlay').classList.remove('open'); }
function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// Username save
document.addEventListener('DOMContentLoaded', function() {
  const saved = localStorage.getItem('geoflyer-username') || '';
  document.getElementById('usernameInput').value = saved;
  document.getElementById('usernameSave').addEventListener('click', function() {
    const input = document.getElementById('usernameInput');
    const val = input.value.trim();
    if (val.length < 1 || val.length > 20 || !/^[a-zA-Z0-9 ]+$/.test(val)) {
      input.style.borderColor = '#f44';
      setTimeout(() => { input.style.borderColor = '#2a2a60'; }, 1500);
      return;
    }
    localStorage.setItem('geoflyer-username', val);
    input.style.borderColor = '#0f0';
    setTimeout(() => { input.style.borderColor = '#2a2a60'; }, 1500);
  });
});
</script>

<script>
(function() {
  const SKIN_NAMES = ['Sci-fi', 'Neon Racer', 'Classic', 'Space Shuttle', 'Phoenix', 'Pirate Ship', 'Ice Crystal', 'Seagull', 'Dolphin', 'Shooting Star', 'Champion', 'Capybara'];
  // Display order: Classic, Rocket, Sci-Fi, Neon, Seagull, Phoenix, Pirate Ship, Ice Crystal, Dolphin, Shooting Star, Champion
  const SKIN_ORDER = [2, 3, 0, 1, 7, 4, 5, 6, 8, 9, 10, 11];
  // Full-screen overlay backgrounds per skin (saturated like GD)
  const SKIN_BG = ['#0c1a3a', '#2e0a4a', '#0a3020', '#0c1020', '#3a1a00', '#1a0e00', '#0a1a2e', '#0a2a3a', '#0a1a30', '#1a0a30', '#2a1a00', '#2a1a08'];
  const PW = 240, PH = 190;
  let activeSkin = parseInt(localStorage.getItem('geoflyer-skin') || '0');
  // Convert stored internal index to display position
  let skinDisplayPos = Math.max(0, SKIN_ORDER.indexOf(activeSkin));
  activeSkin = SKIN_ORDER[skinDisplayPos];

  // Unlock system
  const FREE_SKINS = [0,1,2,3];
  const SKIN_COSTS = {4:50, 5:100, 6:150, 7:200, 8:250};
  // Achievement-locked skins (no coin cost)
  const ACHIEVEMENT_SKINS = {9: {achId: 'survive-1000m', desc: 'Survive 1000 meters'}, 10: {achId: 'leaderboard-1', desc: 'Reach #1 on the leaderboard'}, 11: {achId: 'owner-grant', desc: 'Granted by the owner'}};
  function getAchievements() {
    try { return JSON.parse(localStorage.getItem('geoflyer-achievements') || '{}'); }
    catch(e) { return {}; }
  }
  function hasAchievement(id) { return !!getAchievements()[id]; }
  // Dev unlock: grant everything to np8248
  (function() {
    const u = (localStorage.getItem('geoflyer-username') || '').trim().toLowerCase();
    if (u === 'np8248') {
      localStorage.setItem('geoflyer-unlocked', JSON.stringify([0,1,2,3,4,5,6,7,8,9,10,11]));
      localStorage.setItem('geoflyer-unlocked-trails', JSON.stringify([0,1,2,3,4,5,6,7,8]));
    }
  })();
  // Check if player has been granted capybara skin (skin 11)
  (async function checkCapybaraGrant() {
    try {
      const username = localStorage.getItem('geoflyer-username');
      if (!username) return;
      const res = await fetch('/api/grant');
      const data = await res.json();
      if (data.granted && data.granted.includes(username.trim().toLowerCase())) {
        const skins = JSON.parse(localStorage.getItem('geoflyer-unlocked') || '[0,1,2,3]');
        if (!skins.includes(11)) { skins.push(11); localStorage.setItem('geoflyer-unlocked', JSON.stringify(skins)); }
      }
    } catch(e) {}
  })();
  // Initialize default unlocks if missing
  if (!localStorage.getItem('geoflyer-unlocked')) localStorage.setItem('geoflyer-unlocked', JSON.stringify([0,1,2,3]));
  if (!localStorage.getItem('geoflyer-coins')) localStorage.setItem('geoflyer-coins', '0');
  function getUnlockedSkins() {
    try { return JSON.parse(localStorage.getItem('geoflyer-unlocked') || '[0,1,2,3]'); }
    catch(e) { return [0,1,2,3]; }
  }
  function isSkinUnlocked(idx) { return FREE_SKINS.includes(idx) || getUnlockedSkins().includes(idx); }
  function getCoins() { return parseInt(localStorage.getItem('geoflyer-coins') || '0'); }
  function unlockSkin(idx) {
    const cost = SKIN_COSTS[idx];
    if (!cost || isSkinUnlocked(idx)) return;
    let coins = getCoins();
    if (coins < cost) return;
    coins -= cost;
    localStorage.setItem('geoflyer-coins', coins);
    const unlocked = getUnlockedSkins();
    if (!unlocked.includes(idx)) { unlocked.push(idx); localStorage.setItem('geoflyer-unlocked', JSON.stringify(unlocked)); }
    updateCoinDisplay();
    drawPreview();
  }
  function updateCoinDisplay() {
    const coins = getCoins();
    const txt = '\u2733 ' + coins + ' coins';
    document.getElementById('coinDisplay').textContent = txt;
    document.getElementById('menuCoins').textContent = txt;
  }
  // Validate active skin on load â€” reset to 0 if locked
  if (!isSkinUnlocked(activeSkin)) { activeSkin = 0; localStorage.setItem('geoflyer-skin', '0'); }
  updateCoinDisplay();

  function drawPreview() {
    const skinIdx = activeSkin;
    const canvas = document.getElementById('skinCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, PW, PH);

    // Set full-screen overlay background
    document.getElementById('skinOverlay').style.background = SKIN_BG[skinIdx];

    ctx.save();
    ctx.translate(PW / 2 + 10, PH / 2);
    const S = 80;
    const now = Date.now();

    switch (skinIdx) {
      case 0: { // Sci-fi - twin engine, layered hull, energy lines
        const ft = now * 0.008;
        // Twin plasma trail
        for (let i = 0; i < 10; i++) {
          const fx = -S/2 - 8 - i * 8;
          ctx.globalAlpha = 0.6 - i * 0.055;
          ctx.fillStyle = i < 3 ? '#66ffff' : (i < 6 ? '#0088ff' : '#4400cc');
          ctx.beginPath(); ctx.arc(fx+Math.sin(ft+i)*3, -S/6+Math.sin(ft*1.5+i)*3, Math.max(1,7-i*0.5), 0, Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.arc(fx+Math.sin(ft+i+2)*3, S/6+Math.sin(ft*1.5+i+1)*3, Math.max(1,7-i*0.5), 0, Math.PI*2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        // Twin engine glow
        ctx.save(); ctx.shadowColor = '#0ff'; ctx.shadowBlur = 16;
        ctx.fillStyle = '#66ffff';
        ctx.beginPath(); ctx.arc(-S/2+2, -S/6, 5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(-S/2+2, S/6, 5, 0, Math.PI*2); ctx.fill();
        ctx.restore();
        // Hull
        ctx.fillStyle = '#1a1a2e';
        ctx.beginPath();
        ctx.moveTo(S/2+8, 0);
        ctx.quadraticCurveTo(S/2+4, -S/3, S/6, -S/3);
        ctx.lineTo(-S/3, -S/3); ctx.lineTo(-S/2, -S/5);
        ctx.lineTo(-S/2, S/5); ctx.lineTo(-S/3, S/3);
        ctx.lineTo(S/6, S/3);
        ctx.quadraticCurveTo(S/2+4, S/3, S/2+8, 0);
        ctx.closePath(); ctx.fill();
        // Upper panel
        ctx.fillStyle = '#242448';
        ctx.beginPath();
        ctx.moveTo(S/2+5, -1); ctx.quadraticCurveTo(S/2, -S/3+3, S/6, -S/3+3);
        ctx.lineTo(-S/4, -S/3+3); ctx.lineTo(-S/4, -1);
        ctx.closePath(); ctx.fill();
        // Swept wings
        ctx.fillStyle = '#141430';
        ctx.beginPath(); ctx.moveTo(0, -S/3); ctx.lineTo(-S/4, -S/2-3); ctx.lineTo(-S/2-3, -S/3); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(0, S/3); ctx.lineTo(-S/4, S/2+3); ctx.lineTo(-S/2-3, S/3); ctx.closePath(); ctx.fill();
        // Energy lines
        const pulse0 = 0.6 + Math.sin(ft*3)*0.3;
        ctx.strokeStyle = `rgba(0,255,255,${pulse0})`; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(S/2+4, 0); ctx.lineTo(-S/3, 0); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(S/4, -S/6); ctx.lineTo(-S/4, -S/3+3); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(S/4, S/6); ctx.lineTo(-S/4, S/3-3); ctx.stroke();
        // Cockpit dome
        ctx.save(); ctx.shadowColor = '#0af'; ctx.shadowBlur = 8;
        const cg = ctx.createRadialGradient(S/5, -1, 2, S/5, 0, 8);
        cg.addColorStop(0, '#ffffff'); cg.addColorStop(0.4, '#44ddff'); cg.addColorStop(1, '#0066aa');
        ctx.fillStyle = cg;
        ctx.beginPath(); ctx.ellipse(S/5, 0, 8, 6, 0, 0, Math.PI*2); ctx.fill();
        ctx.restore();
        break;
      }
      case 1: { // Neon Racer
        const nt = now * 0.003;
        const hue = (nt * 30) % 360;
        const c1 = `hsl(${hue}, 100%, 55%)`;
        const c2 = `hsl(${hue + 180}, 100%, 55%)`;
        for (let i = 1; i <= 8; i++) {
          ctx.globalAlpha = 0.35 - i * 0.04;
          ctx.strokeStyle = c1; ctx.lineWidth = 4 - i * 0.4;
          ctx.beginPath(); ctx.moveTo(-S/2 - i * 10, -2); ctx.lineTo(-S/2 - i * 10 - 7, -2); ctx.stroke();
          ctx.strokeStyle = c2;
          ctx.beginPath(); ctx.moveTo(-S/2 - i * 10, 2); ctx.lineTo(-S/2 - i * 10 - 7, 2); ctx.stroke();
        }
        ctx.globalAlpha = 1;
        ctx.save(); ctx.shadowColor = c1; ctx.shadowBlur = 12;
        ctx.fillStyle = c1;
        ctx.beginPath(); ctx.moveTo(S/2 + 5, 0); ctx.lineTo(0, -S/2); ctx.lineTo(-S/2, -S/3); ctx.lineTo(-S/2 + 7, 0); ctx.closePath(); ctx.fill();
        ctx.shadowColor = c2;
        ctx.fillStyle = c2;
        ctx.beginPath(); ctx.moveTo(S/2 + 5, 0); ctx.lineTo(0, S/2); ctx.lineTo(-S/2, S/3); ctx.lineTo(-S/2 + 7, 0); ctx.closePath(); ctx.fill();
        ctx.restore();
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(S/2 + 3, 0); ctx.lineTo(-S/2 + 7, 0); ctx.stroke();
        const pulse = 4 + Math.sin(nt * 3) * 2.5;
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(0, 0, pulse, 0, Math.PI * 2); ctx.fill();
        break;
      }
      case 2: { // Classic GD
        const bob = Math.sin(now * 0.003) * 3;
        ctx.translate(0, bob);
        // Trail
        ctx.globalAlpha = 0.3; ctx.fillStyle = '#0f0';
        ctx.fillRect(-S/2 - 30, -6, 30, 12);
        ctx.globalAlpha = 0.15; ctx.fillRect(-S/2 - 55, -5, 28, 10);
        ctx.globalAlpha = 1;
        const grd2 = ctx.createLinearGradient(-S/2, -S/2, S/2, S/2);
        grd2.addColorStop(0, '#00e676'); grd2.addColorStop(1, '#00bfa5');
        ctx.fillStyle = grd2;
        ctx.beginPath(); ctx.moveTo(S/2, 0); ctx.lineTo(-S/2, -S/2); ctx.lineTo(-S/2 + 10, 0); ctx.lineTo(-S/2, S/2); ctx.closePath(); ctx.fill();
        ctx.fillStyle = '#00c853';
        ctx.beginPath(); ctx.moveTo(-S/6, -S/2 + 3); ctx.lineTo(-S/4, -S/2 - 8); ctx.lineTo(-S/2 + 3, -S/2 + 6); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(-S/6, S/2 - 3); ctx.lineTo(-S/4, S/2 + 8); ctx.lineTo(-S/2 + 3, S/2 - 6); ctx.closePath(); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.15)';
        ctx.beginPath(); ctx.moveTo(S/2 - 8, -2); ctx.lineTo(-S/2 + 10, -S/2 + 10); ctx.lineTo(-S/2 + 18, 0); ctx.closePath(); ctx.fill();
        ctx.strokeStyle = '#1b5e20'; ctx.lineWidth = 2.5;
        ctx.beginPath(); ctx.moveTo(S/2, 0); ctx.lineTo(-S/2, -S/2); ctx.lineTo(-S/2 + 10, 0); ctx.lineTo(-S/2, S/2); ctx.closePath(); ctx.stroke();
        ctx.fillStyle = '#fff'; ctx.fillRect(-4, -8, 16, 13);
        ctx.fillStyle = '#000'; ctx.fillRect(2, -5, 8, 8);
        break;
      }
      case 3: { // Space Shuttle
        const rt = now * 0.01;
        // Engine exhaust - blue-white plasma
        for (let i = 0; i < 10; i++) {
          const fx = -S/2 - 6 - i * 6 + Math.sin(rt * 2 + i * 1.3) * 2;
          const fy = Math.sin(rt + i * 0.8) * 3;
          const sz = 5 - i * 0.4;
          ctx.globalAlpha = 0.7 - i * 0.06;
          ctx.fillStyle = i < 3 ? '#ccddff' : (i < 6 ? '#6688ff' : '#3344aa');
          ctx.beginPath(); ctx.arc(fx, fy, Math.max(1, sz), 0, Math.PI * 2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        // Engine pods (top and bottom)
        ctx.fillStyle = '#555566';
        ctx.fillRect(-S/2 - 3, -S/3 - 2, S/4, 5);
        ctx.fillRect(-S/2 - 3, S/3 - 3, S/4, 5);
        ctx.fillStyle = '#6688ff';
        ctx.beginPath(); ctx.arc(-S/2, -S/3, 2.5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(-S/2, S/3, 2.5, 0, Math.PI*2); ctx.fill();
        // Main fuselage - metallic silver/gray
        const fGrd = ctx.createLinearGradient(0, -S/3, 0, S/3);
        fGrd.addColorStop(0, '#aaaabb'); fGrd.addColorStop(0.4, '#dddde8'); fGrd.addColorStop(0.6, '#ccccdd'); fGrd.addColorStop(1, '#888899');
        ctx.fillStyle = fGrd;
        ctx.beginPath();
        ctx.moveTo(S/2 + 4, 0);
        ctx.quadraticCurveTo(S/2 + 2, -S/4, S/6, -S/4);
        ctx.lineTo(-S/2, -S/4);
        ctx.lineTo(-S/2, S/4);
        ctx.lineTo(S/6, S/4);
        ctx.quadraticCurveTo(S/2 + 2, S/4, S/2 + 4, 0);
        ctx.closePath(); ctx.fill();
        // Delta wings
        ctx.fillStyle = '#777788';
        ctx.beginPath(); ctx.moveTo(-S/6, -S/4); ctx.lineTo(-S/3, -S/2 - 1); ctx.lineTo(-S/2, -S/4); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(-S/6, S/4); ctx.lineTo(-S/3, S/2 + 1); ctx.lineTo(-S/2, S/4); ctx.closePath(); ctx.fill();
        // Fuselage seam line
        ctx.strokeStyle = '#666677'; ctx.lineWidth = 0.8;
        ctx.beginPath(); ctx.moveTo(S/3, 0); ctx.lineTo(-S/2 + 2, 0); ctx.stroke();
        // Cockpit windshield
        ctx.save(); ctx.shadowColor = '#aaddff'; ctx.shadowBlur = 5;
        const wg = ctx.createLinearGradient(S/4, -3, S/4, 3);
        wg.addColorStop(0, '#cceeff'); wg.addColorStop(1, '#6699cc');
        ctx.fillStyle = wg;
        ctx.beginPath();
        ctx.moveTo(S/2 + 2, 0);
        ctx.quadraticCurveTo(S/2, -S/6, S/4, -S/6);
        ctx.lineTo(S/4, S/6);
        ctx.quadraticCurveTo(S/2, S/6, S/2 + 2, 0);
        ctx.closePath(); ctx.fill();
        ctx.restore();
        // Outline
        ctx.strokeStyle = '#555566'; ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(S/2 + 4, 0);
        ctx.quadraticCurveTo(S/2 + 2, -S/4, S/6, -S/4);
        ctx.lineTo(-S/2, -S/4); ctx.lineTo(-S/2, S/4); ctx.lineTo(S/6, S/4);
        ctx.quadraticCurveTo(S/2 + 2, S/4, S/2 + 4, 0);
        ctx.closePath(); ctx.stroke();
        break;
      }
      case 4: { // Phoenix
        const pt = now * 0.008;
        const flap = Math.sin(pt * 1.2) * 4;
        const u = S / 40; // scale factor so pixel details match in-game look
        // Ember/flame trail
        for (let i = 0; i < 12; i++) {
          const fx = -S/2 - 4*u - i * 5*u;
          const fy = Math.sin(pt * 2 + i * 1.3) * 4*u;
          const sz = 4.5*u - i * 0.35*u;
          ctx.globalAlpha = 0.7 - i * 0.055;
          ctx.fillStyle = i < 3 ? '#ff2200' : (i < 6 ? '#ff6600' : (i < 9 ? '#ffaa00' : '#ffdd44'));
          ctx.beginPath(); ctx.arc(fx, fy, Math.max(1, sz), 0, Math.PI*2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        // Tail flames (sharp pointed shapes)
        ctx.fillStyle = '#cc2200';
        ctx.beginPath();
        ctx.moveTo(-S/6, 0); ctx.lineTo(-S/2 - 6*u, -S/5); ctx.lineTo(-S/2, -S/10); ctx.closePath(); ctx.fill();
        ctx.beginPath();
        ctx.moveTo(-S/6, 0); ctx.lineTo(-S/2 - 6*u, S/5); ctx.lineTo(-S/2, S/10); ctx.closePath(); ctx.fill();
        ctx.fillStyle = '#ff6600';
        ctx.beginPath();
        ctx.moveTo(-S/6, 0); ctx.lineTo(-S/2 - 10*u, 0); ctx.lineTo(-S/2 - 2*u, -S/14); ctx.closePath(); ctx.fill();
        ctx.beginPath();
        ctx.moveTo(-S/6, 0); ctx.lineTo(-S/2 - 10*u, 0); ctx.lineTo(-S/2 - 2*u, S/14); ctx.closePath(); ctx.fill();
        // Flickering flame tips
        const fl1 = Math.sin(pt * 4) * 2*u;
        const fl2 = Math.sin(pt * 5 + 1) * 2*u;
        ctx.fillStyle = '#ffcc00'; ctx.globalAlpha = 0.8;
        ctx.beginPath(); ctx.moveTo(-S/2 - 6*u, -S/5); ctx.lineTo(-S/2 - 10*u + fl1, -S/4); ctx.lineTo(-S/2 - 3*u, -S/6); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(-S/2 - 6*u, S/5); ctx.lineTo(-S/2 - 10*u + fl2, S/4); ctx.lineTo(-S/2 - 3*u, S/6); ctx.closePath(); ctx.fill();
        ctx.globalAlpha = 1;
        // Wings (sharp, angular, jagged flame edges)
        const wgrd = ctx.createLinearGradient(0, -S/2, 0, 0);
        wgrd.addColorStop(0, '#ffaa00'); wgrd.addColorStop(1, '#dd4400');
        ctx.fillStyle = wgrd;
        // Top wing
        ctx.beginPath();
        ctx.moveTo(S/8, -S/8);
        ctx.lineTo(S/10, -S/4 - flap);
        ctx.lineTo(-S/8, -S/2 - 2*u - flap);
        ctx.lineTo(-S/6, -S/3 - flap);
        ctx.lineTo(-S/3, -S/2 + 1*u - flap);
        ctx.lineTo(-S/4, -S/4 - flap);
        ctx.lineTo(-S/3, -S/8);
        ctx.closePath(); ctx.fill();
        // Bottom wing
        ctx.beginPath();
        ctx.moveTo(S/8, S/8);
        ctx.lineTo(S/10, S/4 + flap);
        ctx.lineTo(-S/8, S/2 + 2*u + flap);
        ctx.lineTo(-S/6, S/3 + flap);
        ctx.lineTo(-S/3, S/2 - 1*u + flap);
        ctx.lineTo(-S/4, S/4 + flap);
        ctx.lineTo(-S/3, S/8);
        ctx.closePath(); ctx.fill();
        // Flame glow at wing tips
        ctx.fillStyle = '#ffee44'; ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.moveTo(-S/8, -S/2 - 2*u - flap); ctx.lineTo(-S/8 - 3*u, -S/2 - 5*u - flap); ctx.lineTo(-S/8 + 3*u, -S/2 - 1*u - flap); ctx.closePath(); ctx.fill();
        ctx.beginPath();
        ctx.moveTo(-S/8, S/2 + 2*u + flap); ctx.lineTo(-S/8 - 3*u, S/2 + 5*u + flap); ctx.lineTo(-S/8 + 3*u, S/2 + 1*u + flap); ctx.closePath(); ctx.fill();
        ctx.globalAlpha = 1;
        // Body (angular diamond/kite shape)
        const bgrd = ctx.createLinearGradient(-S/4, -S/6, S/4, S/6);
        bgrd.addColorStop(0, '#ff5500'); bgrd.addColorStop(0.5, '#ee3300'); bgrd.addColorStop(1, '#cc1100');
        ctx.fillStyle = bgrd;
        ctx.beginPath();
        ctx.moveTo(S/3 + 4*u, 0);
        ctx.lineTo(S/8, -S/6);
        ctx.lineTo(-S/4, -S/7);
        ctx.lineTo(-S/6, 0);
        ctx.lineTo(-S/4, S/7);
        ctx.lineTo(S/8, S/6);
        ctx.closePath(); ctx.fill();
        // Bright belly line
        ctx.strokeStyle = '#ff8800'; ctx.lineWidth = 1*u;
        ctx.beginPath(); ctx.moveTo(S/3, 0); ctx.lineTo(-S/6, 0); ctx.stroke();
        // Head (angular)
        ctx.fillStyle = '#ee3300';
        ctx.beginPath();
        ctx.moveTo(S/2 + 5*u, 0);
        ctx.lineTo(S/3 + 2*u, -S/7);
        ctx.lineTo(S/6, -S/8);
        ctx.lineTo(S/6, S/8);
        ctx.lineTo(S/3 + 2*u, S/7);
        ctx.closePath(); ctx.fill();
        // Crest (tall sharp flame spikes)
        ctx.fillStyle = '#ffcc00';
        ctx.beginPath();
        ctx.moveTo(S/5, -S/7);
        ctx.lineTo(S/5 - 2*u, -S/7 - 7*u);
        ctx.lineTo(S/5 + 2*u, -S/7 - 2*u);
        ctx.lineTo(S/5 + 4*u, -S/7 - 9*u);
        ctx.lineTo(S/5 + 6*u, -S/7 - 3*u);
        ctx.lineTo(S/5 + 7*u, -S/7);
        ctx.closePath(); ctx.fill();
        // Sharp beak
        ctx.fillStyle = '#ff8800';
        ctx.beginPath();
        ctx.moveTo(S/2 + 5*u, 0);
        ctx.lineTo(S/3 + 3*u, -2*u);
        ctx.lineTo(S/3 + 3*u, 2*u);
        ctx.closePath(); ctx.fill();
        // Fierce angular eye
        ctx.save(); ctx.shadowColor = '#ff6600'; ctx.shadowBlur = 6*u;
        ctx.fillStyle = '#ffee44';
        ctx.beginPath();
        ctx.moveTo(S/3, -1*u);
        ctx.lineTo(S/4 + 1*u, -3*u);
        ctx.lineTo(S/4 - 1*u, -1*u);
        ctx.lineTo(S/4 + 1*u, 1*u);
        ctx.closePath(); ctx.fill();
        ctx.restore();
        ctx.fillStyle = '#111';
        ctx.beginPath(); ctx.arc(S/4 + 2*u, -1*u, 1*u, 0, Math.PI*2); ctx.fill();
        break;
      }
      case 5: { // Pirate Ship
        const st = now * 0.005;
        // Wake/splash trail
        for (let i = 0; i < 8; i++) {
          const wx = -S/2 - 6 - i * 7;
          const wy = S/8 + Math.sin(st * 2.5 + i * 1.5) * 2;
          const sz = 3.5 - i * 0.35;
          ctx.globalAlpha = 0.35 - i * 0.035;
          ctx.fillStyle = '#88bbdd';
          ctx.beginPath(); ctx.arc(wx, wy, Math.max(1, sz), 0, Math.PI*2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        // Sail (behind hull) - billowing to the right
        const wave = Math.sin(st * 2) * 1.5;
        ctx.fillStyle = '#eee8d0';
        ctx.beginPath();
        ctx.moveTo(-S/10, -S/5);
        ctx.lineTo(-S/10, -S/2 - 10);
        ctx.quadraticCurveTo(S/4 + wave, -S/3 - 5, S/5 + wave, -S/5 - 2);
        ctx.closePath(); ctx.fill();
        ctx.strokeStyle = '#bbb098'; ctx.lineWidth = 0.6;
        ctx.beginPath();
        ctx.moveTo(-S/10, -S/5);
        ctx.lineTo(-S/10, -S/2 - 10);
        ctx.quadraticCurveTo(S/4 + wave, -S/3 - 5, S/5 + wave, -S/5 - 2);
        ctx.closePath(); ctx.stroke();
        // Mast
        ctx.strokeStyle = '#3a2000'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(-S/10, -S/5); ctx.lineTo(-S/10, -S/2 - 13); ctx.stroke();
        // Jolly roger flag at mast top
        const fw = Math.sin(st * 3) * 2;
        ctx.fillStyle = '#111';
        ctx.fillRect(-S/10 + 1, -S/2 - 18 + fw, 9, 7);
        ctx.fillStyle = '#ddd';
        ctx.beginPath(); ctx.arc(-S/10 + 5, -S/2 - 15.5 + fw, 1.5, 0, Math.PI*2); ctx.fill();
        ctx.fillRect(-S/10 + 4, -S/2 - 13 + fw, 1.5, 2);
        // Hull - flat deck on top, curved bottom
        const hGrd = ctx.createLinearGradient(0, -S/5, 0, S/4);
        hGrd.addColorStop(0, '#A07830'); hGrd.addColorStop(0.4, '#8B6914'); hGrd.addColorStop(1, '#6B4F10');
        ctx.fillStyle = hGrd;
        ctx.beginPath();
        ctx.moveTo(S/2 + 6, -S/10);
        ctx.lineTo(S/3, -S/5);
        ctx.lineTo(-S/3, -S/5);
        ctx.lineTo(-S/2, -S/4);
        ctx.lineTo(-S/2, S/8);
        ctx.quadraticCurveTo(-S/6, S/3 + 2, S/6, S/4);
        ctx.quadraticCurveTo(S/3, S/5, S/2 + 6, -S/10);
        ctx.closePath(); ctx.fill();
        // Plank lines
        ctx.strokeStyle = '#5a3a08'; ctx.lineWidth = 0.5;
        ctx.beginPath(); ctx.moveTo(-S/3, -S/10); ctx.lineTo(S/3, -S/10); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(-S/3, S/12); ctx.lineTo(S/4, S/12); ctx.stroke();
        // Deck railing
        ctx.strokeStyle = '#6B4F10'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(S/3, -S/5 - 1); ctx.lineTo(-S/3, -S/5 - 1); ctx.stroke();
        // Cannon ports
        ctx.fillStyle = '#222';
        ctx.beginPath(); ctx.arc(-S/6, S/16, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(S/10, S/16, 2, 0, Math.PI*2); ctx.fill();
        // Stern cabin window
        ctx.fillStyle = '#ffdd66';
        ctx.fillRect(-S/2 + 2, -S/6, 4, 3);
        // Hull outline
        ctx.strokeStyle = '#4a2a00'; ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(S/2 + 6, -S/10);
        ctx.lineTo(S/3, -S/5);
        ctx.lineTo(-S/3, -S/5);
        ctx.lineTo(-S/2, -S/4);
        ctx.lineTo(-S/2, S/8);
        ctx.quadraticCurveTo(-S/6, S/3 + 2, S/6, S/4);
        ctx.quadraticCurveTo(S/3, S/5, S/2 + 6, -S/10);
        ctx.closePath(); ctx.stroke();
        break;
      }
      case 6: { // Ice Crystal
        const it = now * 0.006;
        // Sparkle/snowflake trail
        for (let i = 0; i < 8; i++) {
          const fx = -S/2 - 8 - i * 8 + Math.sin(it * 1.2 + i * 2) * 4;
          const fy = Math.sin(it * 1.8 + i * 1.5) * 10;
          const sz = 4 - i * 0.4;
          ctx.globalAlpha = 0.6 - i * 0.065;
          ctx.fillStyle = i % 2 === 0 ? '#aaddff' : '#ffffff';
          ctx.beginPath(); ctx.arc(fx, fy, Math.max(0.5, sz), 0, Math.PI * 2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        // Crystalline diamond body
        const igrd = ctx.createLinearGradient(-S/2, -S/2, S/2, S/2);
        igrd.addColorStop(0, '#88ccff'); igrd.addColorStop(0.5, '#cceeff'); igrd.addColorStop(1, '#66aaee');
        ctx.fillStyle = igrd;
        ctx.beginPath();
        ctx.moveTo(S/2 + 8, 0); ctx.lineTo(0, -S/2);
        ctx.lineTo(-S/2, -S/4); ctx.lineTo(-S/2 + 6, 0);
        ctx.lineTo(-S/2, S/4); ctx.lineTo(0, S/2);
        ctx.closePath(); ctx.fill();
        // Faceted highlights
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.beginPath(); ctx.moveTo(S/2 + 4, 0); ctx.lineTo(0, -S/2 + 6); ctx.lineTo(-S/4, 0); ctx.closePath(); ctx.fill();
        ctx.fillStyle = 'rgba(200,230,255,0.15)';
        ctx.beginPath(); ctx.moveTo(S/4, -S/4); ctx.lineTo(-S/6, -S/3); ctx.lineTo(-S/6, 0); ctx.closePath(); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.beginPath(); ctx.moveTo(-S/4, 0); ctx.lineTo(-S/2 + 6, S/4); ctx.lineTo(0, S/3); ctx.closePath(); ctx.fill();
        // Icy outline
        ctx.strokeStyle = '#88bbee'; ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(S/2 + 8, 0); ctx.lineTo(0, -S/2); ctx.lineTo(-S/2, -S/4);
        ctx.lineTo(-S/2 + 6, 0); ctx.lineTo(-S/2, S/4); ctx.lineTo(0, S/2);
        ctx.closePath(); ctx.stroke();
        // Sparkle accents
        const sp = Math.sin(it * 3) * 0.3 + 0.7;
        ctx.globalAlpha = sp;
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(S/6, -S/6, 3, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.arc(-S/6, S/6, 2, 0, Math.PI * 2); ctx.fill();
        ctx.globalAlpha = 1;
        break;
      }
      case 7: { // Seagull
        const gt = now * 0.006;
        const flap = Math.sin(gt * 1.5) * 3;
        // White wisp trail
        for (let i = 0; i < 8; i++) {
          const fx = -S/2 - 6 - i * 7 + Math.sin(gt * 1.3 + i * 1.5) * 3;
          const fy = Math.sin(gt * 1.6 + i * 1.2) * 5;
          const sz = 3 - i * 0.3;
          ctx.globalAlpha = 0.35 - i * 0.04;
          ctx.fillStyle = '#ddeeff';
          ctx.beginPath(); ctx.arc(fx, fy, Math.max(0.5, sz), 0, Math.PI*2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        // Tail feathers
        ctx.fillStyle = '#99aabb';
        ctx.beginPath();
        ctx.moveTo(-S/4, -1);
        ctx.lineTo(-S/2 - 6, -S/8);
        ctx.lineTo(-S/2 - 8, 0);
        ctx.lineTo(-S/2 - 6, S/8);
        ctx.lineTo(-S/4, 1);
        ctx.closePath(); ctx.fill();
        // Wings (long, curved, with flap)
        ctx.fillStyle = '#dde8f0';
        ctx.beginPath();
        ctx.moveTo(S/8, -2);
        ctx.quadraticCurveTo(S/10, -S/4 - flap, -S/4, -S/2 - 3 - flap);
        ctx.lineTo(-S/3 - 2, -S/2 + 2 - flap);
        ctx.quadraticCurveTo(-S/5, -S/5 - flap, -S/4, -2);
        ctx.closePath(); ctx.fill();
        ctx.beginPath();
        ctx.moveTo(S/8, 2);
        ctx.quadraticCurveTo(S/10, S/4 + flap, -S/4, S/2 + 3 + flap);
        ctx.lineTo(-S/3 - 2, S/2 - 2 + flap);
        ctx.quadraticCurveTo(-S/5, S/5 + flap, -S/4, 2);
        ctx.closePath(); ctx.fill();
        // Dark wing tips
        ctx.fillStyle = '#556677';
        ctx.beginPath();
        ctx.moveTo(-S/4 - 2, -S/2 - 1 - flap);
        ctx.lineTo(-S/3 - 4, -S/2 + 1 - flap);
        ctx.lineTo(-S/3, -S/2 + 5 - flap);
        ctx.closePath(); ctx.fill();
        ctx.beginPath();
        ctx.moveTo(-S/4 - 2, S/2 + 1 + flap);
        ctx.lineTo(-S/3 - 4, S/2 - 1 + flap);
        ctx.lineTo(-S/3, S/2 - 5 + flap);
        ctx.closePath(); ctx.fill();
        // Body (oval)
        ctx.fillStyle = '#f0f4f8';
        ctx.beginPath(); ctx.ellipse(0, 0, S/3, S/7, 0, 0, Math.PI*2); ctx.fill();
        // Belly highlight
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.beginPath(); ctx.ellipse(0, 2, S/4, S/10, 0, 0, Math.PI*2); ctx.fill();
        // Head
        ctx.fillStyle = '#f0f4f8';
        ctx.beginPath(); ctx.arc(S/4 + 2, -1, S/7, 0, Math.PI*2); ctx.fill();
        // Beak
        ctx.fillStyle = '#eeaa33';
        ctx.beginPath();
        ctx.moveTo(S/4 + S/7, -1);
        ctx.lineTo(S/2 + 7, -1);
        ctx.lineTo(S/2 + 5, 2);
        ctx.quadraticCurveTo(S/2 + 3, 3, S/4 + S/7, 1);
        ctx.closePath(); ctx.fill();
        // Eye
        ctx.fillStyle = '#222';
        ctx.beginPath(); ctx.arc(S/4 + 4, -2, 2, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(S/4 + 4.5, -2.5, 0.7, 0, Math.PI*2); ctx.fill();
        break;
      }
      case 8: { // Dolphin
        const dt = now * 0.007;
        // Water droplet trail
        for (let i = 0; i < 8; i++) {
          const fx = -S/2 - 8 - i * 8 + Math.sin(dt * 1.4 + i * 1.8) * 4;
          const fy = Math.sin(dt * 2.0 + i * 1.3) * 8;
          const sz = 4 - i * 0.4;
          ctx.globalAlpha = 0.5 - i * 0.055;
          ctx.fillStyle = i % 2 === 0 ? '#66bbee' : '#aaddff';
          ctx.beginPath(); ctx.arc(fx, fy, Math.max(0.5, sz), 0, Math.PI * 2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        // Smooth curved blue-gray body
        const dgrd = ctx.createLinearGradient(0, -S/2, 0, S/2);
        dgrd.addColorStop(0, '#5588aa'); dgrd.addColorStop(0.5, '#88bbcc'); dgrd.addColorStop(1, '#ccddee');
        ctx.fillStyle = dgrd;
        ctx.beginPath();
        ctx.moveTo(S/2 + 8, 0);
        ctx.quadraticCurveTo(S/2 + 4, -S/3, S/6, -S/3);
        ctx.lineTo(-S/2, -S/4);
        ctx.lineTo(-S/2, S/4);
        ctx.lineTo(S/6, S/3);
        ctx.quadraticCurveTo(S/2 + 4, S/3, S/2 + 8, 0);
        ctx.closePath(); ctx.fill();
        // Lighter belly
        ctx.fillStyle = 'rgba(220,238,248,0.35)';
        ctx.beginPath();
        ctx.moveTo(S/2 + 4, 2);
        ctx.quadraticCurveTo(S/3, S/3 - 2, -S/3, S/4);
        ctx.lineTo(-S/3, 2);
        ctx.closePath(); ctx.fill();
        // Dorsal fin
        ctx.fillStyle = '#4477aa';
        ctx.beginPath(); ctx.moveTo(0, -S/3); ctx.lineTo(-S/8, -S/2 - 5); ctx.lineTo(-S/4, -S/3); ctx.closePath(); ctx.fill();
        // Tail fluke
        ctx.fillStyle = '#5588aa';
        ctx.beginPath(); ctx.moveTo(-S/2, -S/4); ctx.lineTo(-S/2 - 10, -S/3 - 5); ctx.lineTo(-S/3, -S/5); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(-S/2, S/4); ctx.lineTo(-S/2 - 10, S/3 + 5); ctx.lineTo(-S/3, S/5); ctx.closePath(); ctx.fill();
        // Eye
        ctx.fillStyle = '#224';
        ctx.beginPath(); ctx.arc(S/5, -3, 3.5, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(S/5 + 1, -3.5, 1.2, 0, Math.PI * 2); ctx.fill();
        break;
      }
      case 9: { // Shooting Star
        const st2 = now * 0.008;
        // Long rainbow/gold sparkle trail
        for (let i = 0; i < 12; i++) {
          const fx = -S/2 - 8 - i * 8 + Math.sin(st2 + i * 0.8) * 3;
          const fy = Math.sin(st2 * 1.5 + i * 1.2) * 6;
          const sz = 5 - i * 0.35;
          ctx.globalAlpha = 0.7 - i * 0.055;
          const hue2 = (st2 * 40 + i * 30) % 360;
          ctx.fillStyle = `hsl(${hue2}, 90%, 65%)`;
          ctx.beginPath(); ctx.arc(fx, fy, Math.max(0.5, sz), 0, Math.PI * 2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        // Radiating glow
        ctx.save();
        ctx.shadowColor = '#ffdd44'; ctx.shadowBlur = 22;
        // Golden-white pointed star shape
        ctx.fillStyle = '#ffe866';
        ctx.beginPath();
        ctx.moveTo(S/2 + 10, 0);
        ctx.lineTo(S/8, -S/6);
        ctx.lineTo(0, -S/2);
        ctx.lineTo(-S/8, -S/6);
        ctx.lineTo(-S/2, -S/5);
        ctx.lineTo(-S/5, 0);
        ctx.lineTo(-S/2, S/5);
        ctx.lineTo(-S/8, S/6);
        ctx.lineTo(0, S/2);
        ctx.lineTo(S/8, S/6);
        ctx.closePath(); ctx.fill();
        ctx.restore();
        // White glow overlay
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.beginPath();
        ctx.moveTo(S/2 + 6, 0); ctx.lineTo(S/8, -S/8); ctx.lineTo(-S/6, 0); ctx.lineTo(S/8, S/8);
        ctx.closePath(); ctx.fill();
        // Sparkle accents
        const sp2 = Math.sin(st2 * 3) * 0.3 + 0.7;
        ctx.globalAlpha = sp2;
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(S/6, -S/5, 3, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.arc(-S/6, S/5, 2, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.arc(S/4, S/8, 2, 0, Math.PI * 2); ctx.fill();
        ctx.globalAlpha = 1;
        break;
      }
      case 10: { // Champion
        const ct = now * 0.008;
        // Gold sparkle trail
        for (let i = 0; i < 8; i++) {
          ctx.globalAlpha = 0.5 - i * 0.05;
          ctx.fillStyle = i % 2 === 0 ? '#ffd600' : '#ffee66';
          ctx.beginPath(); ctx.arc(-S/2 - i * 10, Math.sin(ct * 2 + i) * 6, 3 - i * 0.3, 0, Math.PI * 2); ctx.fill();
        }
        ctx.globalAlpha = 1;
        // Gold hull shape (rotated "1")
        ctx.save();
        ctx.shadowColor = '#ffd600'; ctx.shadowBlur = 18;
        ctx.fillStyle = '#ffd600';
        ctx.beginPath();
        ctx.moveTo(S/2 + 6, 0);
        ctx.lineTo(S/6, -S/3);
        ctx.lineTo(-S/3, -S/3);
        ctx.lineTo(-S/3, -S/2 - 4);
        ctx.lineTo(-S/2 - 4, -S/3);
        ctx.lineTo(-S/2, -S/3);
        ctx.lineTo(-S/2, S/3);
        ctx.lineTo(S/6, S/3);
        ctx.closePath(); ctx.fill();
        ctx.restore();
        // Lighter overlay
        ctx.fillStyle = 'rgba(255,238,102,0.35)';
        ctx.beginPath();
        ctx.moveTo(S/3, 0); ctx.lineTo(0, -S/5); ctx.lineTo(-S/4, -S/5);
        ctx.lineTo(-S/4, S/5); ctx.lineTo(0, S/5);
        ctx.closePath(); ctx.fill();
        // Trophy in center
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(-8, -8); ctx.lineTo(8, -8); ctx.lineTo(5, 2); ctx.lineTo(-5, 2);
        ctx.closePath(); ctx.fill();
        ctx.fillRect(-2, 2, 4, 5);
        ctx.fillRect(-5, 7, 10, 2);
        // Sparkle accents
        const csp = Math.sin(ct * 3) * 0.3 + 0.7;
        ctx.globalAlpha = csp;
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(S/4, -S/6, 3, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.arc(-S/5, S/5, 2, 0, Math.PI * 2); ctx.fill();
        ctx.globalAlpha = 1;
        break;
      }
      case 11: { // Capybara
        const S = Math.min(PW, PH) * 0.55;
        // Thick dark brown outline blob body
        ctx.save();
        ctx.shadowColor = '#4A3228'; ctx.shadowBlur = 5;
        ctx.fillStyle = '#DEB896';
        ctx.strokeStyle = '#4A3228'; ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(S/2, 0);
        ctx.quadraticCurveTo(S/2, -S/2.5, S/6, -S/2.8);
        ctx.quadraticCurveTo(-S/6, -S/2.5, -S/3, -S/3);
        ctx.quadraticCurveTo(-S/2 - 4, -S/4, -S/2 - 4, 0);
        ctx.quadraticCurveTo(-S/2 - 4, S/3, -S/3, S/3);
        ctx.lineTo(S/6, S/3);
        ctx.quadraticCurveTo(S/2, S/3, S/2, 0);
        ctx.closePath(); ctx.fill(); ctx.stroke();
        ctx.restore();
        // Darker tan spots
        ctx.fillStyle = '#C4A07A';
        ctx.beginPath(); ctx.ellipse(-S/6, -S/8, 5, 3, 0.3, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(-S/4, S/6, 4, 2.5, -0.2, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(0, S/8, 3, 2, 0.5, 0, Math.PI * 2); ctx.fill();
        // Stubby legs with outline
        ctx.fillStyle = '#DEB896'; ctx.strokeStyle = '#4A3228'; ctx.lineWidth = 2.5;
        ctx.beginPath();
        ctx.moveTo(-S/5 - 5, S/3 - 2);
        ctx.quadraticCurveTo(-S/5 - 6, S/3 + 8, -S/5, S/3 + 8);
        ctx.quadraticCurveTo(-S/5 + 6, S/3 + 8, -S/5 + 5, S/3 - 2);
        ctx.fill(); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(S/8 - 5, S/3 - 2);
        ctx.quadraticCurveTo(S/8 - 6, S/3 + 8, S/8, S/3 + 8);
        ctx.quadraticCurveTo(S/8 + 6, S/3 + 8, S/8 + 5, S/3 - 2);
        ctx.fill(); ctx.stroke();
        // Tiny ear bump
        ctx.fillStyle = '#DEB896'; ctx.strokeStyle = '#4A3228'; ctx.lineWidth = 2.5;
        ctx.beginPath(); ctx.arc(S/8, -S/2.8 - 2, 5, Math.PI, 0); ctx.fill(); ctx.stroke();
        // Small tilted oval eye
        ctx.fillStyle = '#2A1A10';
        ctx.save(); ctx.translate(S/4, -S/6); ctx.rotate(-0.3);
        ctx.beginPath(); ctx.ellipse(0, 0, 4, 2.5, 0, 0, Math.PI * 2); ctx.fill();
        ctx.restore();
        // Rosy cheek
        ctx.fillStyle = 'rgba(210,140,140,0.45)';
        ctx.beginPath(); ctx.arc(S/4 + 4, -S/14, 6, 0, Math.PI * 2); ctx.fill();
        // Orange on back with leaf
        ctx.fillStyle = '#D06030';
        ctx.beginPath(); ctx.arc(-S/10, -S/2.8 - 4, 6, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#E08040';
        ctx.beginPath(); ctx.arc(-S/10, -S/2.8 - 5, 5.5, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#5A8030';
        ctx.beginPath();
        ctx.moveTo(-S/10, -S/2.8 - 11);
        ctx.quadraticCurveTo(-S/10 + 6, -S/2.8 - 14, -S/10 + 3, -S/2.8 - 8);
        ctx.closePath(); ctx.fill();
        // "C" on body
        ctx.fillStyle = '#4A3228';
        ctx.font = 'bold ' + Math.floor(S * 0.25) + 'px Arial';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText('C', -S/6, 4);
        break;
      }
    }
    ctx.restore();

    // Lock overlay for locked skins
    const locked = !isSkinUnlocked(skinIdx);
    if (locked) {
      ctx.save();
      ctx.fillStyle = 'rgba(0,0,0,0.55)';
      ctx.fillRect(0, 0, PW, PH);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 40px Arial';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText('\uD83D\uDD12', PW/2, PH/2);
      ctx.restore();
    }

    document.getElementById('skinName').textContent = SKIN_NAMES[skinIdx];

    // Update dot indicators (in display order)
    const dotsEl = document.getElementById('skinDots');
    if (dotsEl.children.length !== SKIN_ORDER.length) {
      dotsEl.innerHTML = '';
      for (let i = 0; i < SKIN_ORDER.length; i++) {
        const dot = document.createElement('div');
        dot.style.cssText = 'width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.25);transition:all 0.15s;cursor:pointer;';
        dot.addEventListener('click', () => { selectSkin(i); });
        dotsEl.appendChild(dot);
      }
    }
    const currentSkin = parseInt(localStorage.getItem('geoflyer-skin') || '0');
    for (let i = 0; i < dotsEl.children.length; i++) {
      const dot = dotsEl.children[i];
      const internalIdx = SKIN_ORDER[i];
      const isCurrent = internalIdx === currentSkin;
      const isViewing = internalIdx === skinIdx;
      if (isViewing) {
        dot.style.background = '#fff';
        dot.style.transform = 'scale(1.3)';
        dot.style.boxShadow = '0 0 6px rgba(255,255,255,0.6)';
      } else if (isCurrent) {
        dot.style.background = '#0af';
        dot.style.transform = 'scale(1.1)';
        dot.style.boxShadow = '0 0 4px rgba(0,170,255,0.5)';
      } else {
        dot.style.background = 'rgba(255,255,255,0.25)';
        dot.style.transform = 'scale(1)';
        dot.style.boxShadow = 'none';
      }
    }

    // Update status text and unlock button
    const statusEl = document.getElementById('skinStatus');
    const unlockEl = document.getElementById('unlockBtn');
    if (locked) {
      const achInfo = ACHIEVEMENT_SKINS[skinIdx];
      if (achInfo) {
        statusEl.textContent = 'Achievement: ' + achInfo.desc;
        statusEl.style.color = '#ffaa44';
        unlockEl.style.display = 'none';
      } else {
        const cost = SKIN_COSTS[skinIdx] || 0;
        const coins = getCoins();
        statusEl.textContent = 'Locked \u2014 ' + cost + ' coins';
        statusEl.style.color = '#ff6666';
        unlockEl.style.display = 'inline-block';
        unlockEl.textContent = '\uD83D\uDD13 Unlock (' + cost + ' coins)';
        if (coins < cost) {
          unlockEl.style.opacity = '0.4';
          unlockEl.style.cursor = 'not-allowed';
          unlockEl.onclick = null;
        } else {
          unlockEl.style.opacity = '1';
          unlockEl.style.cursor = 'pointer';
          unlockEl.onclick = function() { unlockSkin(skinIdx); };
        }
      }
    } else {
      statusEl.textContent = activeSkin === parseInt(localStorage.getItem('geoflyer-skin')) ? '' : '';
      statusEl.style.color = '#66ff66';
      unlockEl.style.display = 'none';
    }
    updateCoinDisplay();
  }

  function animLoop() {
    if (document.getElementById('skinOverlay').classList.contains('open')) {
      drawPreview();
    }
    requestAnimationFrame(animLoop);
  }

  function selectSkin(displayPos) {
    skinDisplayPos = ((displayPos % SKIN_ORDER.length) + SKIN_ORDER.length) % SKIN_ORDER.length;
    activeSkin = SKIN_ORDER[skinDisplayPos];
    // Only save to localStorage if skin is unlocked (can still browse locked skins)
    if (isSkinUnlocked(activeSkin)) {
      localStorage.setItem('geoflyer-skin', activeSkin);
    }
  }

  document.getElementById('skinPrev').addEventListener('click', () => selectSkin(skinDisplayPos - 1));
  document.getElementById('skinNext').addEventListener('click', () => selectSkin(skinDisplayPos + 1));

  animLoop();

  // Achievements list
  const ACHIEVEMENTS = [
    // Coin collecting (least to greatest)
    { id: 'collect-25-run', name: 'Sweet Tooth', desc: 'Collect 25 coins in one run', reward: 'Unlocks Candy trail' },
    { id: 'collect-100', name: 'Coin Hoarder', desc: 'Collect 100 coins in one run', reward: 'Unlocks Rainbow trail' },
    // Survival (least to greatest)
    { id: 'survive-1000m', name: 'Marathon Flyer', desc: 'Survive 1000 meters', reward: 'Unlocks Shooting Star skin' },
    { id: 'survive-2000m', name: 'Blizzard Runner', desc: 'Survive 2000 meters', reward: 'Unlocks Snow trail' },
    // Loyalty
    { id: 'loyal-10', name: 'Loyal Flyer', desc: 'Play same skin 10 games in a row (300m+ each)', reward: 'Unlocks Skin Echo trail' },
    // Power-ups
    { id: 'die-invincible', name: 'Ironic Death', desc: 'Die while invincible power-up is active', reward: 'Unlocks Fire trail' },
    { id: 'bamboozled-3', name: 'Bamboozle Survivor', desc: 'Get bamboozled 3 times in one run', reward: 'Unlocks Laser trail' }
  ];
  function populateAchievements() {
    const list = document.getElementById('achList');
    list.innerHTML = '';
    const achs = getAchievements();
    for (const ach of ACHIEVEMENTS) {
      const done = !!achs[ach.id];
      const card = document.createElement('div');
      card.style.cssText = 'display:flex;align-items:center;gap:14px;padding:14px 18px;border-radius:12px;border:2px solid ' + (done ? '#44cc66' : '#333355') + ';background:' + (done ? 'rgba(0,255,100,0.08)' : 'rgba(20,20,50,0.8)') + ';';
      const icon = document.createElement('div');
      icon.style.cssText = 'font-size:28px;width:40px;text-align:center;flex-shrink:0;';
      icon.textContent = done ? '\u2705' : '\uD83D\uDD12';
      const info = document.createElement('div');
      info.style.cssText = 'flex:1;';
      const title = document.createElement('div');
      title.style.cssText = 'color:' + (done ? '#44cc66' : '#aaa') + ';font-size:16px;font-weight:bold;';
      title.textContent = ach.name;
      const desc = document.createElement('div');
      desc.style.cssText = 'color:#888;font-size:13px;margin-top:2px;';
      desc.textContent = ach.desc;
      const reward = document.createElement('div');
      reward.style.cssText = 'color:#ffaa44;font-size:12px;margin-top:3px;';
      reward.textContent = ach.reward;
      info.appendChild(title);
      info.appendChild(desc);
      info.appendChild(reward);
      card.appendChild(icon);
      card.appendChild(info);
      list.appendChild(card);
    }
  }
  // Populate on overlay open
  const achObs = new MutationObserver(() => {
    if (document.getElementById('achOverlay').classList.contains('open')) populateAchievements();
  });
  achObs.observe(document.getElementById('achOverlay'), { attributes: true, attributeFilter: ['class'] });

  // Trail selector
  const TRAIL_NAMES = ['None','Smoke','Fire','Rainbow','Candy','Snow','Skin Echo','Laser','Champion'];
  const TRAIL_COLORS = [
    null,
    ['#888888','#777777','#666666','#555555'],
    ['#ff2200','#ff6600','#ff9900','#ffcc00'],
    ['#ff0000','#ff8800','#ffff00','#33ff33','#0099ff','#6633ff'],
    ['#ff44aa','#ff88cc','#88ddff','#ffee44'],
    ['#aaddff','#cceeff','#ffffff','#ddeeff'],
    null,
    null,
    ['#ffd600','#ffee66','#ffffff']
  ];
  const FREE_TRAILS = [0, 1];
  // Display order: None, Smoke, Candy(25 coins), Rainbow(100 coins), Skin Echo(loyal), Snow(2000m), Fire(invincible), Laser(bamboozled)
  const TRAIL_ORDER = [0, 1, 4, 3, 6, 5, 2, 7, 8];
  const TRAIL_ACHIEVEMENTS = {
    2: {achId: 'die-invincible', desc: 'Die while invincible power-up is active'},
    3: {achId: 'collect-100', desc: 'Collect 100 coins in one run'},
    4: {achId: 'collect-25-run', desc: 'Collect 25 coins in one run'},
    5: {achId: 'survive-2000m', desc: 'Survive 2000 meters'},
    6: {achId: 'loyal-10', desc: 'Play same skin 10 games (300m+ each)'},
    7: {achId: 'bamboozled-3', desc: 'Get bamboozled 3 times in one run'},
    8: {achId: 'leaderboard-1', desc: 'Reach #1 on the leaderboard'}
  };
  function getUnlockedTrails() {
    try { return JSON.parse(localStorage.getItem('geoflyer-unlocked-trails') || '[0,1]'); }
    catch(e) { return [0,1]; }
  }
  function isTrailUnlocked(idx) { return FREE_TRAILS.includes(idx) || getUnlockedTrails().includes(idx); }
  let activeTrail = parseInt(localStorage.getItem('geoflyer-trail') || '0');
  if (!isTrailUnlocked(activeTrail)) { activeTrail = 0; localStorage.setItem('geoflyer-trail', '0'); }
  let trailDisplayPos = Math.max(0, TRAIL_ORDER.indexOf(activeTrail));
  activeTrail = TRAIL_ORDER[trailDisplayPos];
  const trailCanvas = document.getElementById('trailCanvas');
  const trailCtx = trailCanvas.getContext('2d');

  function drawTrailPreview() {
    const w = 200, h = 80;
    trailCtx.clearRect(0, 0, w, h);
    const t = Date.now() * 0.008;
    const unlocked = isTrailUnlocked(activeTrail);
    document.getElementById('trailName').textContent = TRAIL_NAMES[activeTrail] + (unlocked ? '' : ' (Locked)');

    if (activeTrail === 0) {
      trailCtx.fillStyle = 'rgba(255,255,255,0.4)';
      trailCtx.font = '14px Arial';
      trailCtx.textAlign = 'center';
      trailCtx.fillText('No trail', w/2, h/2 + 5);
    } else if (activeTrail === 1) {
      // Smoke â€” puffy expanding clouds
      const tc = TRAIL_COLORS[1];
      for (let i = 0; i < 14; i++) {
        const age = (t * 0.6 + i * 0.4) % 5;
        const fx = w - 30 - i * 12;
        const fy = h/2 + Math.sin(t*0.5+i*0.7)*4 - age*1.5;
        const sz = 4 + age*3 + i*0.4;
        trailCtx.globalAlpha = Math.max(0, 0.4 - i*0.027);
        trailCtx.fillStyle = tc[i % tc.length];
        trailCtx.beginPath(); trailCtx.arc(fx, fy, sz, 0, Math.PI*2); trailCtx.fill();
        trailCtx.beginPath(); trailCtx.arc(fx+4, fy-3, sz*0.6, 0, Math.PI*2); trailCtx.fill();
      }
      trailCtx.globalAlpha = 1;
    } else if (activeTrail === 2) {
      // Fire â€” shooting flame jet + particles
      const grd = trailCtx.createLinearGradient(w-15, 0, 0, 0);
      grd.addColorStop(0, 'rgba(255,255,200,0.7)');
      grd.addColorStop(0.2, 'rgba(255,220,0,0.5)');
      grd.addColorStop(0.5, 'rgba(255,100,0,0.3)');
      grd.addColorStop(1, 'rgba(255,0,0,0)');
      trailCtx.fillStyle = grd;
      const fl = Math.sin(t*6)*3;
      trailCtx.beginPath();
      trailCtx.moveTo(w-15, h/2-12+fl);
      trailCtx.lineTo(10+Math.sin(t*4)*10, h/2+fl*0.5);
      trailCtx.lineTo(w-15, h/2+12+fl);
      trailCtx.closePath(); trailCtx.fill();
      for (let i = 0; i < 14; i++) {
        const fx = w-20 - i*12 + Math.sin(t*3+i*1.1)*(3+i*0.5);
        const fy = h/2 + Math.sin(t*4+i*1.7)*(4+i*0.8) + fl*0.3;
        const sz = Math.max(1, 8 - i*0.45);
        trailCtx.globalAlpha = Math.max(0, 0.8-i*0.055);
        trailCtx.fillStyle = i<3?'#ffffcc':(i<6?'#ffcc00':(i<10?'#ff6600':'#cc2200'));
        trailCtx.beginPath(); trailCtx.arc(fx, fy, sz, 0, Math.PI*2); trailCtx.fill();
      }
      trailCtx.globalAlpha = 1;
    } else if (activeTrail === 3) {
      // Rainbow â€” hue-cycling sparkles
      for (let i = 0; i < 16; i++) {
        const fx = w - 30 - i * 10 + Math.sin(t+i*0.8)*3;
        const fy = h/2 + Math.sin(t*1.5+i*1.2)*12;
        const sz = 7 - i*0.35;
        trailCtx.globalAlpha = 0.7 - i*0.04;
        const hue = (t * 40 + i * 30) % 360;
        trailCtx.fillStyle = `hsl(${hue}, 90%, 65%)`;
        trailCtx.beginPath(); trailCtx.arc(fx, fy, Math.max(1,sz), 0, Math.PI*2); trailCtx.fill();
      }
      trailCtx.globalAlpha = 1;
    } else if (activeTrail === 4) {
      // Candy â€” tumbling pieces falling down
      const candyColors = ['#ff44aa','#ff88cc','#88ddff','#ffee44','#66ff66','#ff6644'];
      for (let i = 0; i < 12; i++) {
        const seed = i*137.5;
        const age = (t*0.7+seed)%4;
        const fx = w-20 - age*40;
        const fy = h/3 + age*age*3 + Math.sin(seed)*6;
        const sz = 6 - age*0.8;
        const spin = t*3+seed;
        trailCtx.globalAlpha = Math.max(0, 0.8-age*0.18);
        trailCtx.save();
        trailCtx.translate(fx, fy);
        trailCtx.rotate(spin);
        trailCtx.fillStyle = candyColors[i%candyColors.length];
        if (i%3===0) { trailCtx.beginPath(); trailCtx.arc(0,0,sz,0,Math.PI*2); trailCtx.fill(); }
        else if (i%3===1) { trailCtx.fillRect(-sz,-sz,sz*2,sz*2); }
        else { trailCtx.beginPath(); for(let p=0;p<5;p++){const a=(p*4*Math.PI/5)-Math.PI/2;const r=p%2===0?sz*1.2:sz*0.5;if(p===0)trailCtx.moveTo(Math.cos(a)*r,Math.sin(a)*r);else trailCtx.lineTo(Math.cos(a)*r,Math.sin(a)*r);}trailCtx.closePath();trailCtx.fill(); }
        trailCtx.restore();
      }
      trailCtx.globalAlpha = 1;
    } else if (activeTrail === 5) {
      // Snow â€” snowflake crystals
      for (let i = 0; i < 14; i++) {
        const phase = i / 14;  // evenly spaced
        const age = (t * 0.5 + phase * 4) % 4;
        const seed = i * 73.7;
        const fx = w - 30 - age * 22;
        const fy = h/2 + Math.sin(seed + t * 0.3) * 10 + age * 2;
        const sz = 7 - age * 0.8;
        const spin = t * 1.5 + seed;
        trailCtx.globalAlpha = Math.max(0, 0.75 - age * 0.18);
        trailCtx.strokeStyle = i % 3 === 0 ? '#ffffff' : (i % 3 === 1 ? '#cceeff' : '#aaddff');
        trailCtx.lineWidth = 1;
        trailCtx.save();
        trailCtx.translate(fx, fy);
        trailCtx.rotate(spin);
        for (let a = 0; a < 6; a++) {
          const ang = a * Math.PI / 3;
          const cx = Math.cos(ang), sy = Math.sin(ang);
          trailCtx.beginPath(); trailCtx.moveTo(0, 0); trailCtx.lineTo(cx * sz, sy * sz); trailCtx.stroke();
          trailCtx.beginPath(); trailCtx.moveTo(cx * sz * 0.5, sy * sz * 0.5);
          trailCtx.lineTo(cx * sz * 0.5 + Math.cos(ang + 0.8) * sz * 0.3, sy * sz * 0.5 + Math.sin(ang + 0.8) * sz * 0.3);
          trailCtx.stroke();
          trailCtx.beginPath(); trailCtx.moveTo(cx * sz * 0.5, sy * sz * 0.5);
          trailCtx.lineTo(cx * sz * 0.5 + Math.cos(ang - 0.8) * sz * 0.3, sy * sz * 0.5 + Math.sin(ang - 0.8) * sz * 0.3);
          trailCtx.stroke();
        }
        trailCtx.restore();
      }
      trailCtx.globalAlpha = 1;
    } else if (activeTrail === 6) {
      // Skin Echo â€” show text preview
      trailCtx.fillStyle = 'rgba(255,255,255,0.5)';
      trailCtx.font = '13px Arial';
      trailCtx.textAlign = 'center';
      trailCtx.fillText('Drops mini copies of your skin', w/2, h/2 + 5);
    } else if (activeTrail === 7) {
      // Laser â€” animated wavy neon line
      trailCtx.save();
      trailCtx.strokeStyle = '#0ff';
      trailCtx.shadowColor = '#0ff';
      trailCtx.shadowBlur = 12;
      trailCtx.lineWidth = 3;
      trailCtx.beginPath();
      for (let i = 0; i <= 40; i++) {
        const lx = 10 + i * (w - 20) / 40;
        const ly = h/2 + Math.sin(t * 2 + i * 0.3) * 12;
        if (i === 0) trailCtx.moveTo(lx, ly); else trailCtx.lineTo(lx, ly);
      }
      trailCtx.stroke();
      // Bright white tip at end
      trailCtx.strokeStyle = '#fff';
      trailCtx.shadowColor = '#fff';
      trailCtx.shadowBlur = 16;
      trailCtx.lineWidth = 2;
      trailCtx.beginPath();
      for (let i = 35; i <= 40; i++) {
        const lx = 10 + i * (w - 20) / 40;
        const ly = h/2 + Math.sin(t * 2 + i * 0.3) * 12;
        if (i === 35) trailCtx.moveTo(lx, ly); else trailCtx.lineTo(lx, ly);
      }
      trailCtx.stroke();
      trailCtx.restore();
    } else if (activeTrail === 8) { // Champion â€” gold "1"s and trophies tumbling
      const champColors = ['#ffd600','#ffee66','#fff','#cc9900'];
      for (let i = 0; i < 10; i++) {
        const seed = i * 137.5;
        const age = (t * 0.7 + seed) % 4;
        const px = w * 0.7 - age * (w * 0.15);
        const py = h/2 - 10 + age * age * 4 + Math.sin(seed) * 8;
        const sz = 8 - age;
        const spin = t * 3 + seed;
        trailCtx.globalAlpha = Math.max(0, 0.85 - age * 0.18);
        trailCtx.save();
        trailCtx.translate(px, py);
        trailCtx.rotate(spin);
        trailCtx.fillStyle = champColors[i % champColors.length];
        if (i % 2 === 0) {
          // "1" text
          trailCtx.font = 'bold ' + Math.max(6, Math.floor(sz * 2)) + 'px Arial';
          trailCtx.textAlign = 'center'; trailCtx.textBaseline = 'middle';
          trailCtx.fillText('1', 0, 0);
        } else {
          // Trophy shape
          trailCtx.beginPath();
          trailCtx.moveTo(-sz, -sz); trailCtx.lineTo(sz, -sz);
          trailCtx.lineTo(sz * 0.6, sz * 0.3); trailCtx.lineTo(-sz * 0.6, sz * 0.3);
          trailCtx.closePath(); trailCtx.fill();
          trailCtx.fillRect(-sz * 0.15, sz * 0.3, sz * 0.3, sz * 0.4);
          trailCtx.fillRect(-sz * 0.5, sz * 0.7, sz, sz * 0.2);
        }
        trailCtx.restore();
      }
      trailCtx.globalAlpha = 1;
    }

    // Lock overlay for locked trails
    if (!unlocked) {
      trailCtx.fillStyle = 'rgba(0,0,0,0.5)';
      trailCtx.fillRect(0, 0, w, h);
      trailCtx.fillStyle = '#fff';
      trailCtx.font = '24px Arial';
      trailCtx.textAlign = 'center';
      trailCtx.fillText('\uD83D\uDD12', w/2, h/2 - 5);
      trailCtx.font = '11px Arial';
      trailCtx.fillStyle = '#ffaa44';
      const achInfo = TRAIL_ACHIEVEMENTS[activeTrail];
      trailCtx.fillText(achInfo ? achInfo.desc : 'Complete achievement to unlock', w/2, h/2 + 18);
    }

    // Dots (in display order)
    const dotsEl = document.getElementById('trailDots');
    if (dotsEl.children.length !== TRAIL_ORDER.length) {
      dotsEl.innerHTML = '';
      for (let i = 0; i < TRAIL_ORDER.length; i++) {
        const dot = document.createElement('div');
        dot.style.cssText = 'width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.25);transition:all 0.15s;cursor:pointer;';
        dot.addEventListener('click', () => { selectTrail(i); });
        dotsEl.appendChild(dot);
      }
    }
    for (let i = 0; i < dotsEl.children.length; i++) {
      const trailIdx = TRAIL_ORDER[i];
      dotsEl.children[i].style.background = trailIdx === activeTrail ? '#fff' : 'rgba(255,255,255,0.25)';
      dotsEl.children[i].style.transform = trailIdx === activeTrail ? 'scale(1.3)' : 'scale(1)';
    }
  }

  function selectTrail(displayPos) {
    trailDisplayPos = ((displayPos % TRAIL_ORDER.length) + TRAIL_ORDER.length) % TRAIL_ORDER.length;
    activeTrail = TRAIL_ORDER[trailDisplayPos];
    if (isTrailUnlocked(activeTrail)) {
      localStorage.setItem('geoflyer-trail', activeTrail);
    }
  }
  document.getElementById('trailPrev').addEventListener('click', () => selectTrail(trailDisplayPos - 1));
  document.getElementById('trailNext').addEventListener('click', () => selectTrail(trailDisplayPos + 1));

  // Animate trail preview
  function trailAnimLoop() {
    if (document.getElementById('trailOverlay').classList.contains('open')) drawTrailPreview();
    requestAnimationFrame(trailAnimLoop);
  }
  trailAnimLoop();

  // Mini preview: draw active skin into the menu button canvas
  function drawSkinBtnPreview() {
    const savedSkin = parseInt(localStorage.getItem('geoflyer-skin') || '0');
    const btnCanvas = document.getElementById('skinBtnCanvas');
    const bctx = btnCanvas.getContext('2d');
    const bw = 60, bh = 48;
    bctx.clearRect(0, 0, bw, bh);
    bctx.save();
    bctx.translate(bw / 2 + 2, bh / 2);
    const S = 22;
    const now = Date.now();
    switch (savedSkin) {
      case 0: { // Sci-fi mini
        bctx.fillStyle = '#1a1a2e';
        bctx.beginPath();
        bctx.moveTo(S/2+2, 0); bctx.lineTo(-S/3, -S/3); bctx.lineTo(-S/2, 0); bctx.lineTo(-S/3, S/3);
        bctx.closePath(); bctx.fill();
        bctx.fillStyle = '#66ffff'; bctx.beginPath(); bctx.arc(-S/2, -S/6, 2, 0, Math.PI*2); bctx.fill();
        bctx.beginPath(); bctx.arc(-S/2, S/6, 2, 0, Math.PI*2); bctx.fill();
        break;
      }
      case 1: { // Neon Racer mini
        const hue = (now * 0.09) % 360;
        bctx.fillStyle = `hsl(${hue}, 100%, 55%)`;
        bctx.beginPath(); bctx.moveTo(S/2, 0); bctx.lineTo(0, -S/2); bctx.lineTo(-S/2, 0); bctx.closePath(); bctx.fill();
        bctx.fillStyle = `hsl(${hue+180}, 100%, 55%)`;
        bctx.beginPath(); bctx.moveTo(S/2, 0); bctx.lineTo(0, S/2); bctx.lineTo(-S/2, 0); bctx.closePath(); bctx.fill();
        break;
      }
      case 2: { // Classic mini
        const grd = bctx.createLinearGradient(-S/2, -S/2, S/2, S/2);
        grd.addColorStop(0, '#00e676'); grd.addColorStop(1, '#00bfa5');
        bctx.fillStyle = grd;
        bctx.beginPath(); bctx.moveTo(S/2, 0); bctx.lineTo(-S/2, -S/2); bctx.lineTo(-S/2+4, 0); bctx.lineTo(-S/2, S/2); bctx.closePath(); bctx.fill();
        bctx.fillStyle = '#fff'; bctx.fillRect(-1, -3, 6, 5);
        bctx.fillStyle = '#000'; bctx.fillRect(1, -2, 3, 3);
        break;
      }
      case 3: { // Space Shuttle mini
        bctx.fillStyle = '#ccccdd';
        bctx.beginPath();
        bctx.moveTo(S/2, 0); bctx.lineTo(S/6, -S/4); bctx.lineTo(-S/2, -S/4); bctx.lineTo(-S/2, S/4); bctx.lineTo(S/6, S/4);
        bctx.closePath(); bctx.fill();
        bctx.fillStyle = '#cceeff'; bctx.beginPath(); bctx.arc(S/4, 0, 3, 0, Math.PI*2); bctx.fill();
        break;
      }
      case 4: { // Phoenix mini
        bctx.fillStyle = '#ff5500';
        bctx.beginPath(); bctx.moveTo(S/2, 0); bctx.lineTo(0, -S/3); bctx.lineTo(-S/3, 0); bctx.lineTo(0, S/3); bctx.closePath(); bctx.fill();
        bctx.fillStyle = '#ffcc00';
        bctx.beginPath(); bctx.moveTo(0, -S/3); bctx.lineTo(-2, -S/3-5); bctx.lineTo(4, -S/3); bctx.closePath(); bctx.fill();
        break;
      }
      case 5: { // Pirate Ship mini
        bctx.fillStyle = '#5a3010';
        bctx.beginPath(); bctx.moveTo(S/2, 0); bctx.lineTo(S/3, S/4); bctx.lineTo(-S/3, S/4); bctx.lineTo(-S/2, 0); bctx.closePath(); bctx.fill();
        bctx.strokeStyle = '#3a2000'; bctx.lineWidth = 1.5;
        bctx.beginPath(); bctx.moveTo(0, S/4); bctx.lineTo(0, -S/2); bctx.stroke();
        bctx.fillStyle = '#eee8d0';
        bctx.beginPath(); bctx.moveTo(0, -S/4); bctx.lineTo(0, -S/2); bctx.lineTo(S/4, -S/4); bctx.closePath(); bctx.fill();
        break;
      }
      case 6: { // Ice Crystal mini
        bctx.strokeStyle = '#88ddff'; bctx.lineWidth = 1.5;
        for (let a = 0; a < 6; a++) {
          const ang = a * Math.PI / 3;
          bctx.beginPath(); bctx.moveTo(0, 0); bctx.lineTo(Math.cos(ang)*S/2, Math.sin(ang)*S/2); bctx.stroke();
        }
        break;
      }
      case 7: { // Seagull mini
        bctx.fillStyle = '#fff';
        bctx.beginPath(); bctx.ellipse(0, 0, S/3, S/5, 0, 0, Math.PI*2); bctx.fill();
        bctx.fillStyle = '#ff8800'; bctx.beginPath(); bctx.moveTo(S/3, 0); bctx.lineTo(S/2+2, 0); bctx.lineTo(S/3, 2); bctx.closePath(); bctx.fill();
        break;
      }
      case 8: { // Dolphin mini
        bctx.fillStyle = '#4488cc';
        bctx.beginPath(); bctx.ellipse(0, 0, S/2, S/4, 0, 0, Math.PI*2); bctx.fill();
        bctx.fillStyle = '#336699';
        bctx.beginPath(); bctx.moveTo(-S/3, 0); bctx.lineTo(-S/2-3, -S/4); bctx.lineTo(-S/2, 0); bctx.closePath(); bctx.fill();
        break;
      }
      case 9: { // Shooting Star mini
        bctx.fillStyle = '#ffd600';
        for (let p = 0; p < 5; p++) {
          const a = (p * 4 * Math.PI / 5) - Math.PI / 2;
          const r = p % 2 === 0 ? S/3 : S/6;
          if (p === 0) bctx.beginPath();
          bctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
        }
        bctx.closePath(); bctx.fill();
        break;
      }
      case 10: { // Champion mini
        bctx.save();
        bctx.shadowColor = '#ffd600'; bctx.shadowBlur = 6;
        bctx.fillStyle = '#ffd600';
        bctx.beginPath();
        bctx.moveTo(S/3, 0); bctx.lineTo(S/8, -S/4); bctx.lineTo(-S/4, -S/4);
        bctx.lineTo(-S/4, -S/3); bctx.lineTo(-S/3, -S/4);
        bctx.lineTo(-S/3, S/4); bctx.lineTo(S/8, S/4);
        bctx.closePath(); bctx.fill();
        bctx.restore();
        // Mini trophy
        bctx.fillStyle = '#fff';
        bctx.fillRect(-2, -2, 4, 3);
        bctx.fillRect(-0.5, 1, 1, 1.5);
        bctx.fillRect(-1.5, 2.5, 3, 0.8);
        break;
      }
      case 11: { // Capybara mini
        // Blobby tan body with dark outline
        bctx.fillStyle = '#DEB896';
        bctx.strokeStyle = '#4A3228'; bctx.lineWidth = 1.5;
        bctx.beginPath();
        bctx.moveTo(S/3, 0);
        bctx.quadraticCurveTo(S/3, -S/3, 0, -S/3);
        bctx.quadraticCurveTo(-S/3, -S/3, -S/3, 0);
        bctx.quadraticCurveTo(-S/3, S/4, 0, S/4);
        bctx.quadraticCurveTo(S/3, S/4, S/3, 0);
        bctx.closePath(); bctx.fill(); bctx.stroke();
        // Tiny ear bump
        bctx.fillStyle = '#DEB896';
        bctx.beginPath(); bctx.arc(S/10, -S/3, 2, Math.PI, 0); bctx.fill(); bctx.stroke();
        // Tilted oval eye
        bctx.fillStyle = '#2A1A10';
        bctx.save(); bctx.translate(S/8, -S/8); bctx.rotate(-0.3);
        bctx.beginPath(); bctx.ellipse(0, 0, 1.5, 1, 0, 0, Math.PI * 2); bctx.fill();
        bctx.restore();
        // Rosy cheek
        bctx.fillStyle = 'rgba(210,140,140,0.4)';
        bctx.beginPath(); bctx.arc(S/6, 0, 2.5, 0, Math.PI * 2); bctx.fill();
        // Mini orange
        bctx.fillStyle = '#E08040';
        bctx.beginPath(); bctx.arc(-S/10, -S/3 - 1, 2.5, 0, Math.PI * 2); bctx.fill();
        break;
      }
    }
    bctx.restore();
  }

  // Mini preview: draw active trail into the menu button canvas
  function drawTrailBtnPreview() {
    const savedTrail = parseInt(localStorage.getItem('geoflyer-trail') || '0');
    const btnCanvas = document.getElementById('trailBtnCanvas');
    const bctx = btnCanvas.getContext('2d');
    const bw = 60, bh = 48;
    bctx.clearRect(0, 0, bw, bh);
    const t = Date.now() * 0.008;
    if (savedTrail === 0) {
      bctx.fillStyle = 'rgba(255,255,255,0.3)';
      bctx.font = '10px Arial'; bctx.textAlign = 'center';
      bctx.fillText('None', bw/2, bh/2 + 3);
    } else if (savedTrail === 1) {
      for (let i = 0; i < 6; i++) {
        bctx.globalAlpha = 0.4 - i*0.06;
        bctx.fillStyle = '#888';
        bctx.beginPath(); bctx.arc(bw-10-i*8, bh/2+Math.sin(t+i)*2, 3+i*0.3, 0, Math.PI*2); bctx.fill();
      }
      bctx.globalAlpha = 1;
    } else if (savedTrail === 2) {
      for (let i = 0; i < 6; i++) {
        bctx.globalAlpha = 0.7 - i*0.1;
        bctx.fillStyle = i<2?'#ffcc00':(i<4?'#ff6600':'#cc2200');
        bctx.beginPath(); bctx.arc(bw-10-i*8, bh/2+Math.sin(t*3+i)*2, 3, 0, Math.PI*2); bctx.fill();
      }
      bctx.globalAlpha = 1;
    } else if (savedTrail === 3) {
      for (let i = 0; i < 6; i++) {
        bctx.globalAlpha = 0.7 - i*0.08;
        const hue = (t*40+i*50)%360;
        bctx.fillStyle = `hsl(${hue},90%,65%)`;
        bctx.beginPath(); bctx.arc(bw-10-i*8, bh/2+Math.sin(t+i*0.8)*4, 3, 0, Math.PI*2); bctx.fill();
      }
      bctx.globalAlpha = 1;
    } else if (savedTrail === 4) {
      const cc = ['#ff44aa','#ff88cc','#88ddff','#ffee44'];
      for (let i = 0; i < 5; i++) {
        bctx.globalAlpha = 0.7 - i*0.12;
        bctx.fillStyle = cc[i%cc.length];
        bctx.beginPath(); bctx.arc(bw-10-i*9, bh/2+Math.sin(t+i)*3, 2.5, 0, Math.PI*2); bctx.fill();
      }
      bctx.globalAlpha = 1;
    } else if (savedTrail === 5) {
      bctx.strokeStyle = '#cceeff'; bctx.lineWidth = 0.8;
      for (let i = 0; i < 4; i++) {
        bctx.globalAlpha = 0.6 - i*0.12;
        bctx.save(); bctx.translate(bw-12-i*12, bh/2);
        for (let a = 0; a < 6; a++) {
          const ang = a*Math.PI/3;
          bctx.beginPath(); bctx.moveTo(0,0); bctx.lineTo(Math.cos(ang)*4, Math.sin(ang)*4); bctx.stroke();
        }
        bctx.restore();
      }
      bctx.globalAlpha = 1;
    } else if (savedTrail === 6) {
      bctx.fillStyle = 'rgba(255,255,255,0.3)'; bctx.font = '9px Arial'; bctx.textAlign = 'center';
      bctx.fillText('Echo', bw/2, bh/2 + 3);
    } else if (savedTrail === 7) {
      bctx.save(); bctx.strokeStyle = '#0ff'; bctx.shadowColor = '#0ff'; bctx.shadowBlur = 4; bctx.lineWidth = 2;
      bctx.beginPath();
      for (let i = 0; i <= 12; i++) {
        const lx = 5 + i * (bw-10)/12;
        const ly = bh/2 + Math.sin(t*2+i*0.4)*6;
        if (i === 0) bctx.moveTo(lx, ly); else bctx.lineTo(lx, ly);
      }
      bctx.stroke(); bctx.restore();
    } else if (savedTrail === 8) {
      const champCol = ['#ffd600','#ffee66','#fff'];
      for (let i = 0; i < 5; i++) {
        bctx.globalAlpha = 0.7 - i * 0.12;
        bctx.fillStyle = champCol[i % champCol.length];
        const px = bw - 12 - i * 10;
        const py = bh/2 + Math.sin(t * 2 + i * 1.2) * 4;
        if (i % 2 === 0) {
          bctx.font = 'bold 8px Arial'; bctx.textAlign = 'center'; bctx.textBaseline = 'middle';
          bctx.fillText('1', px, py);
        } else {
          bctx.beginPath();
          bctx.moveTo(px-2, py-2); bctx.lineTo(px+2, py-2);
          bctx.lineTo(px+1.5, py); bctx.lineTo(px-1.5, py);
          bctx.closePath(); bctx.fill();
          bctx.fillRect(px-0.3, py, 0.6, 1.5);
          bctx.fillRect(px-1, py+1.5, 2, 0.5);
        }
      }
      bctx.globalAlpha = 1;
    }
  }

  // Call both previews in the existing anim loops
  function skinBtnLoop() { drawSkinBtnPreview(); requestAnimationFrame(skinBtnLoop); }
  function trailBtnLoop() { drawTrailBtnPreview(); requestAnimationFrame(trailBtnLoop); }
  skinBtnLoop();
  trailBtnLoop();
})();
</script>
</body>
</html>
